<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESA Client</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="hero">
    <div class="brand">
      <div class="logo">ESA</div>
      <div class="tagline">Excel Server Application</div>
    </div>
    <div class="session">
      <div id="session-info" class="session-user-info hidden">
        <span id="session-user"></span>
        <button id="logout-btn" type="button" class="btn-small">Logout</button>
      </div>
      <button id="back-to-login" type="button" class="ghost">Login</button>
    </div>
  </header>

  <main>
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab-btn="apps">Applications</button>
      <button class="tab-btn" data-tab-btn="developer">Developer</button>
      <button class="tab-btn" data-tab-btn="admin">Admin</button>
    </div>

    <section class="card" id="apps-panel">
      <div class="panel-head">
        <h2>Applications</h2>
        <div class="search-container">
          <input type="search" id="app-search" placeholder="Search apps by name or group..." />
        </div>
      </div>
      <div id="apps-list" class="apps-store-grid"></div>
    </section>

    <div id="app-overlay" class="app-overlay hidden" aria-hidden="true">
      <div class="app-overlay-content">
        <div class="app-overlay-header">
          <h3 id="app-workspace-title">Select an application</h3>
          <div class="workspace-actions">
            <button type="button" id="app-refresh" class="ghost" disabled>Refresh Data</button>
            <button type="button" id="app-exit" class="ghost" disabled>Close App</button>
          </div>
        </div>
        <div id="app-ui-body" class="app-overlay-body">
          <div class="hint" id="app-ui-empty">Choose an application to load its interface.</div>
          <form id="app-ui-form" class="hidden"></form>
        </div>
        <div class="app-overlay-footer">
          <div class="hint" id="app-workspace-desc">Launch an application to render its authored UI.</div>
        </div>
      </div>
    </div>

    <section class="card tab-content" id="create-panel" data-tab="developer" aria-label="Developer">
      <div class="panel-head">
        <h2>Developer</h2>
        <span class="pill" id="developer-pill">Developer-only</span>
      </div>
      <div class="panel-head" style="margin-top:4px;">
        <h3 style="margin:0;">Your Applications</h3>
        <button id="dev-create-new" type="button">Create New</button>
      </div>
      <div id="developer-list" class="apps-store-grid"></div>
      <p id="create-hint" class="hint">Visible only when your role is Developer or Admin. If the server does not expose roles, you can force-enable once logged in.</p>
    </section>

    <section class="card tab-content" id="admin-panel" data-tab="admin" aria-label="Admin actions">
      <div class="panel-head">
        <h2>Admin</h2>
        <span class="pill warning">Admin-only</span>
      </div>
      <div id="admin-warning" class="hint">Sign in as an administrator to manage users.</div>
      <div id="users-area" class="hidden">
        <h3>Users</h3>
        <table id="users-table">
          <thead><tr><th>Name</th><th>Groups</th><th>Role</th></tr></thead>
          <tbody></tbody>
        </table>
        <h3>Create / Update User</h3>
        <form id="user-form">
          <div class="two-col">
            <label>Username <input name="username" required></label>
            <label>Password <input name="password" required></label>
          </div>
          <div class="two-col">
            <label>Groups (comma) <input name="groups" placeholder="team,project"></label>
            <label>Role
              <select name="role">
                <option value="user">User</option>
                <option value="developer">Developer</option>
              </select>
            </label>
          </div>
          <div class="actions"><button type="submit">Save User</button></div>
        </form>
      </div>
    </section>
  </main>

  <div id="dev-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="dev-modal-title">
      <div class="modal-head">
        <h3 id="dev-modal-title">Create / Update Application</h3>
        <button type="button" id="dev-modal-close" class="ghost icon-btn" aria-label="Close dialog">&#10005;</button>
      </div>
      <div class="hint" id="dev-form-mode">Mode: Create new</div>
      <form id="create-form">
        <div class="two-col">
          <label>Name <input name="name" required></label>
          <label>Access Group <input name="access_group" placeholder="optional"></label>
        </div>
        <label>Description <input name="description"></label>
        <div class="row">
          <label class="checkbox"><input type="checkbox" name="public"> Public (allow everyone)</label>
          <label class="file">
            <span>Select .xlsx file</span>
            <input type="file" name="file" accept=".xlsx" required>
          </label>
        </div>
        <label class="file image-upload">
          <span>Optional preview image (PNG/JPG)</span>
          <input type="file" name="image" accept="image/*">
        </label>
        <div class="actions">
          <button type="submit">Save</button>
          <button type="button" id="dev-modal-cancel" class="ghost">Cancel</button>
          <button type="button" id="developer-override" class="ghost">Force Developer UI</button>
        </div>
      </form>
    </div>
  </div>

  <div id="ui-builder-modal" class="app-overlay hidden" aria-hidden="true">
    <div class="app-overlay-content">
      <div class="app-overlay-header">
        <div>
          <h3 id="ui-builder-title">UI Builder</h3>
          <span id="builder-app-label" class="pill" style="margin-left: 12px;">No app</span>
        </div>
        <button type="button" id="ui-builder-close" class="ghost">Close Builder</button>
      </div>
      <div class="app-overlay-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 18px; padding: 18px;">
        <div class="builder-panel">
          <div class="builder-panel-head">
            <h4>Application Tree</h4>
            <button type="button" id="builder-add-tab" class="btn-small">+ Add Tab</button>
          </div>
          <div class="builder-tree">
            <div class="tree-root">
              <div class="tree-node tree-root-node">
                <span class="tree-icon">ðŸ“‹</span>
                <span id="builder-tree-app-name">Application</span>
              </div>
              <div class="tree-children" style="margin-left: 20px;">
                <div class="tree-node tree-section-node">
                  <span class="tree-icon">ðŸ“Š</span>
                  <span>UI</span>
                </div>
                <div id="builder-tabs-tree" class="tree-children" style="margin-left: 40px;"></div>
              </div>
            </div>
          </div>
          <div id="builder-empty" class="hint">No tabs yet. Add a tab to start building your UI.</div>
        </div>
        <div class="builder-panel">
          <h4 class="builder-panel-head">Editor</h4>
          <div id="builder-tab-editor" class="hidden">
            <form id="builder-tab-form" class="builder-form">
              <input type="hidden" id="builder-tab-id">
              <label>Tab Name
                <input id="builder-tab-name" required placeholder="e.g., Dashboard, Settings">
              </label>
              <div class="actions">
                <button type="submit">Save Tab</button>
                <button type="button" id="builder-tab-cancel" class="ghost">Cancel</button>
              </div>
            </form>
          </div>
          <div id="builder-component-editor" class="hidden">
            <form id="builder-form" class="builder-form">
              <input type="hidden" name="component_id" id="builder-component-id">
              <label>Tab
                <select id="builder-component-tab" required>
                  <option value="">Select a tab...</option>
                </select>
              </label>
              <label>Label
                <input name="label" id="builder-label" required>
              </label>
            <div class="two-col">
              <label>Sheet
                <select name="sheet" id="builder-sheet" required>
                  <option value="">Loading sheetsâ€¦</option>
                </select>
              </label>
              <label>Cell / Range <input name="cell" id="builder-cell" placeholder="A1" required></label>
            </div>
            <label>Component Type
              <select name="componentType" id="builder-component-type">
                <option value="text">Text Input</option>
                <option value="number">Number Input</option>
                <option value="textarea">Text Area</option>
                <option value="dropdown">Dropdown</option>
                <option value="slider">Slider</option>
                <option value="checkbox">Checkbox</option>
                <option value="display">Display (read-only)</option>
              </select>
            </label>
            <div id="builder-options-section" class="hidden">
              <label>Options (comma-separated)
                <input name="options" id="builder-options" placeholder="Option1, Option2, Option3">
                <span class="hint">For dropdowns: enter comma-separated values</span>
              </label>
            </div>
            <div id="builder-range-section" class="hidden">
              <div class="two-col">
                <label>Min Value <input type="number" name="min" id="builder-min" value="0"></label>
                <label>Max Value <input type="number" name="max" id="builder-max" value="100"></label>
              </div>
              <label>Step <input type="number" name="step" id="builder-step" value="1"></label>
            </div>
            <div class="actions">
              <button type="submit" id="builder-save-component">Save Component</button>
              <button type="button" id="builder-reset" class="ghost">Clear Selection</button>
            </div>
          </form>
        </div>
      </div>
      <div class="app-overlay-footer">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="hint" style="margin: 0;">Configure components and map them to Excel cells. Click "Save Layout" when done.</div>
          <button type="button" id="builder-save-layout">Save Layout</button>
        </div>
      </div>
    </div>
  </div>

  <div id="ui-preview-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="ui-preview-title">
      <div class="modal-head">
        <h3 id="ui-preview-title">UI Preview</h3>
        <button type="button" id="ui-preview-close" class="ghost icon-btn" aria-label="Close preview">&#10005;</button>
      </div>
      <p class="hint" id="ui-preview-subtitle">Select an app to preview its interface.</p>
      <div class="workspace-body">
        <div id="ui-preview-empty" class="hint">No components defined yet. Add fields in the builder to see them here.</div>
        <div id="ui-preview-content" class="app-ui-preview"></div>
      </div>
      <div class="actions">
        <button type="button" id="ui-preview-close-btn" class="ghost">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>
  <script src="app.js"></script>
</body>
</html>
