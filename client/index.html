<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESA Client</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="hero">
    <div class="brand">
      <div class="logo">ESA</div>
      <div class="tagline">Excel Server Application</div>
    </div>
    <div class="session">
      <div id="session-info" class="session-user-info hidden">
        <span id="session-user"></span>
        <button id="logout-btn" type="button" class="btn-small">Logout</button>
      </div>
      <button id="back-to-login" type="button" class="ghost">Login</button>
    </div>
  </header>

  <main>
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab-btn="apps">Applications</button>
      <button class="tab-btn" data-tab-btn="developer">Developer</button>
      <button class="tab-btn" data-tab-btn="admin">Admin</button>
    </div>

    <section class="card" id="apps-panel">
      <div class="panel-head">
        <h2>Applications</h2>
        <div class="search-container">
          <input type="search" id="app-search" placeholder="Search apps by name or group..." />
        </div>
      </div>
      <div id="apps-list" class="apps-store-grid"></div>
    </section>

    <div id="app-overlay" class="app-overlay hidden" aria-hidden="true">
      <div class="app-overlay-content">
        <div class="app-overlay-header">
          <h3 id="app-workspace-title">Select an application</h3>
          <div class="workspace-actions">
            <button type="button" id="app-refresh" class="ghost" disabled>Refresh Data</button>
            <button type="button" id="app-exit" class="ghost" disabled>Close App</button>
          </div>
        </div>
        <div id="app-ui-body" class="app-overlay-body">
          <div class="hint" id="app-ui-empty">Choose an application to load its interface.</div>
          <form id="app-ui-form" class="hidden"></form>
        </div>
        <div class="app-overlay-footer">
          <div class="hint" id="app-workspace-desc">Launch an application to render its authored UI.</div>
        </div>
      </div>
    </div>

    <section class="card tab-content" id="create-panel" data-tab="developer" aria-label="Developer">
      <div class="panel-head">
        <h2>Developer</h2>
        <span class="pill" id="developer-pill">Developer-only</span>
      </div>
      <div class="panel-head" style="margin-top:4px;">
        <h3 style="margin:0;">Your Applications</h3>
        <button id="dev-create-new" type="button">Create New</button>
      </div>
      <div id="developer-list" class="apps-store-grid"></div>
      <p id="create-hint" class="hint">Visible only when your role is Developer or Admin. If the server does not expose roles, you can force-enable once logged in.</p>
    </section>

    <section class="card tab-content" id="admin-panel" data-tab="admin" aria-label="Admin actions">
      <div class="panel-head">
        <h2>Admin</h2>
        <span class="pill warning">Admin-only</span>
      </div>
      <div id="admin-warning" class="hint">Sign in as an administrator to manage users.</div>
      <div id="users-area" class="hidden">
        <h3>Users</h3>
        <table id="users-table">
          <thead><tr><th>Name</th><th>Groups</th><th>Role</th></tr></thead>
          <tbody></tbody>
        </table>
        <h3>Create / Update User</h3>
        <form id="user-form">
          <div class="two-col">
            <label>Username <input name="username" required></label>
            <label>Password <input name="password" required></label>
          </div>
          <div class="two-col">
            <label>Groups (comma) <input name="groups" placeholder="team,project"></label>
            <label>Role
              <select name="role">
                <option value="user">User</option>
                <option value="developer">Developer</option>
              </select>
            </label>
          </div>
          <div class="actions"><button type="submit">Save User</button></div>
        </form>
      </div>
    </section>
  </main>

  <div id="dev-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="dev-modal-title">
      <div class="modal-head">
        <h3 id="dev-modal-title">Create / Update Application</h3>
        <button type="button" id="dev-modal-close" class="ghost icon-btn" aria-label="Close dialog">&#10005;</button>
      </div>
      <div class="hint" id="dev-form-mode">Mode: Create new</div>
      <form id="create-form">
        <div class="two-col">
          <label>Name <input name="name" required></label>
          <label>Access Group <input name="access_group" placeholder="optional"></label>
        </div>
        <label>Description <input name="description"></label>
        <div class="row">
          <label class="checkbox"><input type="checkbox" name="public"> Public (allow everyone)</label>
          <label class="file">
            <span>Select .xlsx file</span>
            <input type="file" name="file" accept=".xlsx" required>
          </label>
        </div>
        <label class="file image-upload">
          <span>Optional preview image (PNG/JPG)</span>
          <input type="file" name="image" accept="image/*">
        </label>
        <div class="actions">
          <button type="submit">Save</button>
          <button type="button" id="dev-modal-cancel" class="ghost">Cancel</button>
          <button type="button" id="developer-override" class="ghost">Force Developer UI</button>
        </div>
      </form>
    </div>
  </div>

  <div id="ui-builder-modal" class="app-overlay hidden" aria-hidden="true">
    <div class="app-overlay-content builder-layout">
      <div class="app-overlay-header">
        <div>
          <h3 id="ui-builder-title">UI Builder</h3>
          <span id="builder-app-label" class="pill" style="margin-left: 12px;">No app</span>
        </div>
        <div class="builder-header-actions">
          <button type="button" id="builder-preview-btn" class="ghost">Preview</button>
          <button type="button" id="builder-save-layout" class="btn-small">Save Layout</button>
          <button type="button" id="ui-builder-close" class="ghost">Close</button>
        </div>
      </div>
      
      <div class="builder-main">
        <!-- Left: Widget Palette -->
        <div class="builder-palette">
          <h4 class="palette-title">Widget Palette</h4>
          
          <div class="palette-section">
            <div class="palette-section-title">Containers</div>
            <div class="palette-widgets">
              <button type="button" class="palette-widget" data-widget="panel" title="Panel container">
                <span class="widget-icon">üì¶</span><span>Panel</span>
              </button>
              <button type="button" class="palette-widget" data-widget="notebook" title="Tabbed notebook">
                <span class="widget-icon">üìë</span><span>Notebook</span>
              </button>
              <button type="button" class="palette-widget" data-widget="boxsizer-v" title="Vertical layout">
                <span class="widget-icon">‚¨áÔ∏è</span><span>VBox</span>
              </button>
              <button type="button" class="palette-widget" data-widget="boxsizer-h" title="Horizontal layout">
                <span class="widget-icon">‚û°Ô∏è</span><span>HBox</span>
              </button>
              <button type="button" class="palette-widget" data-widget="gridsizer" title="Grid layout">
                <span class="widget-icon">‚ñ¶</span><span>Grid</span>
              </button>
              <button type="button" class="palette-widget" data-widget="scrolled" title="Scrollable area">
                <span class="widget-icon">üìú</span><span>Scroll</span>
              </button>
            </div>
          </div>
          
          <div class="palette-section">
            <div class="palette-section-title">Inputs</div>
            <div class="palette-widgets">
              <button type="button" class="palette-widget" data-widget="textinput" title="Text input">
                <span class="widget-icon">üìù</span><span>Text</span>
              </button>
              <button type="button" class="palette-widget" data-widget="number" title="Number input">
                <span class="widget-icon">üî¢</span><span>Number</span>
              </button>
              <button type="button" class="palette-widget" data-widget="textarea" title="Multi-line text">
                <span class="widget-icon">üìÑ</span><span>TextArea</span>
              </button>
              <button type="button" class="palette-widget" data-widget="dropdown" title="Dropdown select">
                <span class="widget-icon">üìã</span><span>Dropdown</span>
              </button>
              <button type="button" class="palette-widget" data-widget="checkbox" title="Checkbox">
                <span class="widget-icon">‚òëÔ∏è</span><span>Check</span>
              </button>
              <button type="button" class="palette-widget" data-widget="radio" title="Radio buttons">
                <span class="widget-icon">üîò</span><span>Radio</span>
              </button>
              <button type="button" class="palette-widget" data-widget="slider" title="Slider control">
                <span class="widget-icon">üéöÔ∏è</span><span>Slider</span>
              </button>
              <button type="button" class="palette-widget" data-widget="spinctrl" title="Spin control">
                <span class="widget-icon">üîÑ</span><span>Spin</span>
              </button>
              <button type="button" class="palette-widget" data-widget="datepicker" title="Date picker">
                <span class="widget-icon">üìÖ</span><span>Date</span>
              </button>
              <button type="button" class="palette-widget" data-widget="colorpicker" title="Color picker">
                <span class="widget-icon">üé®</span><span>Color</span>
              </button>
            </div>
          </div>
          
          <div class="palette-section">
            <div class="palette-section-title">Display</div>
            <div class="palette-widgets">
              <button type="button" class="palette-widget" data-widget="label" title="Static text">
                <span class="widget-icon">üè∑Ô∏è</span><span>Label</span>
              </button>
              <button type="button" class="palette-widget" data-widget="output" title="Dynamic output">
                <span class="widget-icon">üëÅÔ∏è</span><span>Output</span>
              </button>
              <button type="button" class="palette-widget" data-widget="image" title="Image display">
                <span class="widget-icon">üñºÔ∏è</span><span>Image</span>
              </button>
              <button type="button" class="palette-widget" data-widget="gauge" title="Progress gauge">
                <span class="widget-icon">üìä</span><span>Gauge</span>
              </button>
              <button type="button" class="palette-widget" data-widget="separator" title="Separator line">
                <span class="widget-icon">‚ûñ</span><span>Line</span>
              </button>
              <button type="button" class="palette-widget" data-widget="spacer" title="Empty spacer">
                <span class="widget-icon">‚¨ú</span><span>Spacer</span>
              </button>
            </div>
          </div>
          
          <div class="palette-section">
            <div class="palette-section-title">Actions</div>
            <div class="palette-widgets">
              <button type="button" class="palette-widget" data-widget="button" title="Action button">
                <span class="widget-icon">üîò</span><span>Button</span>
              </button>
              <button type="button" class="palette-widget" data-widget="togglebtn" title="Toggle button">
                <span class="widget-icon">üîÄ</span><span>Toggle</span>
              </button>
              <button type="button" class="palette-widget" data-widget="link" title="Hyperlink">
                <span class="widget-icon">üîó</span><span>Link</span>
              </button>
            </div>
          </div>
          
          <div class="palette-section">
            <div class="palette-section-title">Data (Excel)</div>
            <div class="palette-widgets">
              <button type="button" class="palette-widget" data-widget="datagrid" title="Cell range grid">
                <span class="widget-icon">üìä</span><span>DataGrid</span>
              </button>
              <button type="button" class="palette-widget" data-widget="chart" title="Excel chart">
                <span class="widget-icon">üìà</span><span>Chart</span>
              </button>
              <button type="button" class="palette-widget" data-widget="formula" title="Formula output">
                <span class="widget-icon">‚àë</span><span>Formula</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Center: Widget Tree -->
        <div class="builder-tree-panel">
          <div class="builder-panel-head">
            <h4>Widget Tree</h4>
          </div>
          <div class="builder-tree" id="builder-widget-tree">
            <div id="builder-tree-root" class="tree-root"></div>
          </div>
          <div id="builder-empty" class="hint">Drag widgets from the palette or click to add them to the tree.</div>
        </div>
        
        <!-- Right: Property Editor -->
        <div class="builder-properties">
          <h4 class="properties-title">Properties</h4>
          <div id="builder-no-selection" class="hint">Select a widget to edit its properties.</div>
          
          <form id="builder-property-form" class="builder-form hidden">
            <input type="hidden" id="prop-widget-id">
            
            <!-- Common Properties -->
            <fieldset class="prop-group">
              <legend>Widget</legend>
              <label>Name <input type="text" id="prop-name" placeholder="widgetName"></label>
              <label>Type <input type="text" id="prop-type" readonly class="readonly"></label>
            </fieldset>
            
            <fieldset class="prop-group" id="prop-group-label">
              <legend>Content</legend>
              <label>Label / Text <input type="text" id="prop-label" placeholder="Widget label"></label>
              <label id="prop-placeholder-row">Placeholder <input type="text" id="prop-placeholder"></label>
              <label id="prop-tooltip-row">Tooltip <input type="text" id="prop-tooltip"></label>
            </fieldset>
            
            <fieldset class="prop-group">
              <legend>Layout</legend>
              <div class="two-col">
                <label>Width <input type="text" id="prop-width" placeholder="auto"></label>
                <label>Height <input type="text" id="prop-height" placeholder="auto"></label>
              </div>
              <div class="two-col">
                <label>Min Width <input type="text" id="prop-min-width" placeholder="0"></label>
                <label>Min Height <input type="text" id="prop-min-height" placeholder="0"></label>
              </div>
              <label>Proportion <input type="number" id="prop-proportion" min="0" value="0" title="Grow factor in sizer"></label>
              <label>Flags
                <select id="prop-flags" multiple size="3">
                  <option value="expand">Expand</option>
                  <option value="align-left">Align Left</option>
                  <option value="align-center">Align Center</option>
                  <option value="align-right">Align Right</option>
                </select>
              </label>
              <div class="two-col">
                <label>Margin <input type="number" id="prop-margin" min="0" value="4"></label>
                <label>Padding <input type="number" id="prop-padding" min="0" value="0"></label>
              </div>
            </fieldset>
            
            <!-- Sizer Properties -->
            <fieldset class="prop-group" id="prop-group-sizer">
              <legend>Sizer Options</legend>
              <label>Orientation
                <select id="prop-orientation">
                  <option value="vertical">Vertical</option>
                  <option value="horizontal">Horizontal</option>
                </select>
              </label>
              <div class="two-col" id="prop-grid-options">
                <label>Columns <input type="number" id="prop-cols" min="1" value="2"></label>
                <label>Rows <input type="number" id="prop-rows" min="0" value="0" placeholder="auto"></label>
              </div>
              <div class="two-col">
                <label>H Gap <input type="number" id="prop-hgap" min="0" value="4"></label>
                <label>V Gap <input type="number" id="prop-vgap" min="0" value="4"></label>
              </div>
            </fieldset>
            
            <!-- Input Properties -->
            <fieldset class="prop-group" id="prop-group-input">
              <legend>Input Options</legend>
              <label id="prop-options-row">Options (comma-separated)
                <input type="text" id="prop-options" placeholder="Option1, Option2">
              </label>
              <div class="two-col" id="prop-range-options">
                <label>Min <input type="number" id="prop-min" value="0"></label>
                <label>Max <input type="number" id="prop-max" value="100"></label>
              </div>
              <label id="prop-step-row">Step <input type="number" id="prop-step" value="1"></label>
              <label id="prop-default-row">Default Value <input type="text" id="prop-default"></label>
            </fieldset>
            
            <!-- Excel Binding (Optional) -->
            <fieldset class="prop-group" id="prop-group-excel">
              <legend>
                <label class="checkbox inline">
                  <input type="checkbox" id="prop-excel-enabled"> Excel Binding
                </label>
              </legend>
              <div id="prop-excel-fields" class="hidden">
                <label>Sheet
                  <select id="prop-sheet">
                    <option value="">Select sheet...</option>
                  </select>
                </label>
                <label>Cell / Range <input type="text" id="prop-cell" placeholder="A1 or A1:C10"></label>
                <label>Mode
                  <select id="prop-mode">
                    <option value="input">Input (push to Excel)</option>
                    <option value="output">Output (read from Excel)</option>
                    <option value="bidirectional">Bidirectional</option>
                  </select>
                </label>
              </div>
            </fieldset>
            
            <!-- Button/Action Properties -->
            <fieldset class="prop-group" id="prop-group-action">
              <legend>Action</legend>
              <label>On Click
                <select id="prop-onclick">
                  <option value="">None</option>
                  <option value="refresh">Refresh Data</option>
                  <option value="submit">Submit Values</option>
                  <option value="recalc">Recalculate</option>
                  <option value="navigate">Navigate to Tab</option>
                  <option value="custom">Custom Script</option>
                </select>
              </label>
              <label id="prop-target-row">Target <input type="text" id="prop-target" placeholder="Target tab or action"></label>
            </fieldset>
            
            <div class="prop-actions">
              <button type="submit" class="btn-small">Apply</button>
              <button type="button" id="prop-delete-widget" class="ghost btn-small danger">Delete</button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="app-overlay-footer">
        <div class="hint" style="margin: 0;">Drag widgets from the palette to the tree. Configure properties on the right. Press Escape to close.</div>
      </div>
    </div>
  </div>

  <div id="ui-preview-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="ui-preview-title">
      <div class="modal-head">
        <h3 id="ui-preview-title">UI Preview</h3>
        <button type="button" id="ui-preview-close" class="ghost icon-btn" aria-label="Close preview">&#10005;</button>
      </div>
      <p class="hint" id="ui-preview-subtitle">Select an app to preview its interface.</p>
      <div class="workspace-body">
        <div id="ui-preview-empty" class="hint">No components defined yet. Add fields in the builder to see them here.</div>
        <div id="ui-preview-content" class="app-ui-preview"></div>
      </div>
      <div class="actions">
        <button type="button" id="ui-preview-close-btn" class="ghost">Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>
  <script src="app.js"></script>
</body>
</html>
